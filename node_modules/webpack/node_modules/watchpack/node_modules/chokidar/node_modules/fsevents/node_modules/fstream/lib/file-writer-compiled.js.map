{"version":3,"sources":["file-writer.js"],"names":[],"mappings":"AAAA,OAAO,OAAP,GAAiB,UAAjB;;AAEA,IAAI,KAAK,QAAQ,aAAR,CAAT;AACA,IAAI,SAAS,QAAQ,aAAR,CAAb;AACA,IAAI,WAAW,QAAQ,UAAR,CAAf;AACA,IAAI,MAAM,EAAV;;AAEA,SAAS,UAAT,EAAqB,MAArB;;AAEA,SAAS,UAAT,CAAqB,KAArB,EAA4B;AAC1B,MAAI,OAAO,IAAX;AACA,MAAI,EAAE,gBAAgB,UAAlB,CAAJ,EAAmC;AACjC,UAAM,IAAI,KAAJ,CAAU,2CAAV,CAAN;AACD;;;AAGD,MAAI,MAAM,IAAN,KAAe,MAAf,IAAyB,CAAC,MAAM,IAApC,EAA0C;AACxC,UAAM,IAAI,KAAJ,CAAU,mBAAmB,MAAM,IAAnC,CAAN;AACD;;AAED,OAAK,OAAL,GAAe,EAAf;AACA,OAAK,aAAL,GAAqB,CAArB;;AAEA,SAAO,IAAP,CAAY,IAAZ,EAAkB,KAAlB;AACD;;AAED,WAAW,SAAX,CAAqB,OAArB,GAA+B,YAAY;AACzC,MAAI,OAAO,IAAX;AACA,MAAI,KAAK,OAAT,EAAkB;;AAElB,MAAI,KAAK,EAAT;AACA,MAAI,KAAK,KAAL,CAAW,KAAf,EAAsB,GAAG,KAAH,GAAW,KAAK,KAAL,CAAW,KAAtB;AACtB,KAAG,IAAH,GAAU,OAAO,QAAjB;AACA,MAAI,KAAK,IAAL,IAAa,KAAK,IAAL,CAAU,OAA3B,EAAoC,GAAG,UAAH,GAAgB,KAAK,IAAL,CAAU,OAA1B;;AAEpC,OAAK,OAAL,GAAe,GAAG,iBAAH,CAAqB,KAAK,KAA1B,EAAiC,EAAjC,CAAf;;AAEA,OAAK,OAAL,CAAa,EAAb,CAAgB,MAAhB,EAAwB,YAAY;;AAElC,SAAK,KAAL,GAAa,IAAb;AACA,SAAK,OAAL,CAAa,OAAb,CAAqB,UAAU,CAAV,EAAa;AAChC,UAAI,MAAM,GAAV,EAAe,KAAK,OAAL,CAAa,GAAb,GAAf,KACK,KAAK,OAAL,CAAa,KAAb,CAAmB,CAAnB;AACN,KAHD;AAIA,SAAK,IAAL,CAAU,OAAV;;AAEA,SAAK,IAAL,CAAU,OAAV;AACD,GAVD;;AAYA,OAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAAyB,UAAU,EAAV,EAAc;AAAE,SAAK,IAAL,CAAU,OAAV,EAAmB,EAAnB;AAAwB,GAAjE;;AAEA,OAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAAyB,YAAY;AAAE,SAAK,IAAL,CAAU,OAAV;AAAoB,GAA3D;;AAEA,OAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAAyB,YAAY;;AAEnC,SAAK,OAAL;AACD,GAHD;AAID,CA/BD;;AAiCA,WAAW,SAAX,CAAqB,KAArB,GAA6B,UAAU,CAAV,EAAa;AACxC,MAAI,OAAO,IAAX;;AAEA,OAAK,aAAL,IAAsB,EAAE,MAAxB;;AAEA,MAAI,CAAC,KAAK,KAAV,EAAiB;AACf,QAAI,CAAC,OAAO,QAAP,CAAgB,CAAhB,CAAD,IAAuB,OAAO,CAAP,KAAa,QAAxC,EAAkD;AAChD,YAAM,IAAI,KAAJ,CAAU,oBAAV,CAAN;AACD;AACD,SAAK,OAAL,CAAa,IAAb,CAAkB,CAAlB;AACA,WAAO,KAAP;AACD;;AAED,MAAI,MAAM,KAAK,OAAL,CAAa,KAAb,CAAmB,CAAnB,CAAV;;;;;AAKA,MAAI,QAAQ,KAAR,IAAiB,KAAK,OAAL,CAAa,MAAlC,EAA0C;AACxC,WAAO,KAAK,OAAL,CAAa,MAAb,CAAoB,MAApB,IAA8B,CAArC;AACD,GAFD,MAEO;AACL,WAAO,GAAP;AACD;AACF,CAvBD;;AAyBA,WAAW,SAAX,CAAqB,GAArB,GAA2B,UAAU,CAAV,EAAa;AACtC,MAAI,OAAO,IAAX;;AAEA,MAAI,CAAJ,EAAO,KAAK,KAAL,CAAW,CAAX;;AAEP,MAAI,CAAC,KAAK,KAAV,EAAiB;AACf,SAAK,OAAL,CAAa,IAAb,CAAkB,GAAlB;AACA,WAAO,KAAP;AACD;;AAED,SAAO,KAAK,OAAL,CAAa,GAAb,EAAP;AACD,CAXD;;AAaA,WAAW,SAAX,CAAqB,OAArB,GAA+B,YAAY;AACzC,MAAI,OAAO,IAAX;AACA,MAAI,OAAO,KAAK,IAAZ,KAAqB,QAArB,IAAiC,KAAK,aAAL,KAAuB,KAAK,IAAjE,EAAuE;AACrE,SAAK,KAAL,CACE,uCACA,UADA,GACa,KAAK,IADlB,GACyB,IADzB,GAEA,UAFA,GAEa,KAAK,aAHpB;AAID;AACD,SAAO,SAAP,CAAiB,OAAjB,CAAyB,IAAzB,CAA8B,IAA9B;AACD,CATD","file":"file-writer-compiled.js","sourcesContent":["module.exports = FileWriter\n\nvar fs = require('graceful-fs')\nvar Writer = require('./writer.js')\nvar inherits = require('inherits')\nvar EOF = {}\n\ninherits(FileWriter, Writer)\n\nfunction FileWriter (props) {\n  var self = this\n  if (!(self instanceof FileWriter)) {\n    throw new Error('FileWriter must be called as constructor.')\n  }\n\n  // should already be established as a File type\n  if (props.type !== 'File' || !props.File) {\n    throw new Error('Non-file type ' + props.type)\n  }\n\n  self._buffer = []\n  self._bytesWritten = 0\n\n  Writer.call(this, props)\n}\n\nFileWriter.prototype._create = function () {\n  var self = this\n  if (self._stream) return\n\n  var so = {}\n  if (self.props.flags) so.flags = self.props.flags\n  so.mode = Writer.filemode\n  if (self._old && self._old.blksize) so.bufferSize = self._old.blksize\n\n  self._stream = fs.createWriteStream(self._path, so)\n\n  self._stream.on('open', function () {\n    // console.error(\"FW open\", self._buffer, self._path)\n    self.ready = true\n    self._buffer.forEach(function (c) {\n      if (c === EOF) self._stream.end()\n      else self._stream.write(c)\n    })\n    self.emit('ready')\n    // give this a kick just in case it needs it.\n    self.emit('drain')\n  })\n\n  self._stream.on('error', function (er) { self.emit('error', er) })\n\n  self._stream.on('drain', function () { self.emit('drain') })\n\n  self._stream.on('close', function () {\n    // console.error('\\n\\nFW Stream Close', self._path, self.size)\n    self._finish()\n  })\n}\n\nFileWriter.prototype.write = function (c) {\n  var self = this\n\n  self._bytesWritten += c.length\n\n  if (!self.ready) {\n    if (!Buffer.isBuffer(c) && typeof c !== 'string') {\n      throw new Error('invalid write data')\n    }\n    self._buffer.push(c)\n    return false\n  }\n\n  var ret = self._stream.write(c)\n  // console.error('\\t-- fw wrote, _stream says', ret, self._stream._queue.length)\n\n  // allow 2 buffered writes, because otherwise there's just too\n  // much stop and go bs.\n  if (ret === false && self._stream._queue) {\n    return self._stream._queue.length <= 2\n  } else {\n    return ret\n  }\n}\n\nFileWriter.prototype.end = function (c) {\n  var self = this\n\n  if (c) self.write(c)\n\n  if (!self.ready) {\n    self._buffer.push(EOF)\n    return false\n  }\n\n  return self._stream.end()\n}\n\nFileWriter.prototype._finish = function () {\n  var self = this\n  if (typeof self.size === 'number' && self._bytesWritten !== self.size) {\n    self.error(\n      'Did not get expected byte count.\\n' +\n      'expect: ' + self.size + '\\n' +\n      'actual: ' + self._bytesWritten)\n  }\n  Writer.prototype._finish.call(self)\n}\n"]}