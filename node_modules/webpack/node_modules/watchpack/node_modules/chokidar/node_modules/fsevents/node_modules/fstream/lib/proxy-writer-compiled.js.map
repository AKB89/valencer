{"version":3,"sources":["proxy-writer.js"],"names":[],"mappings":"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","file":"proxy-writer-compiled.js","sourcesContent":["// A writer for when we don't know what kind of thing\n// the thing is.  That is, it's not explicitly set,\n// so we're going to make it whatever the thing already\n// is, or \"File\"\n//\n// Until then, collect all events.\n\nmodule.exports = ProxyWriter\n\nvar Writer = require('./writer.js')\nvar getType = require('./get-type.js')\nvar inherits = require('inherits')\nvar collect = require('./collect.js')\nvar fs = require('fs')\n\ninherits(ProxyWriter, Writer)\n\nfunction ProxyWriter (props) {\n  var self = this\n  if (!(self instanceof ProxyWriter)) {\n    throw new Error('ProxyWriter must be called as constructor.')\n  }\n\n  self.props = props\n  self._needDrain = false\n\n  Writer.call(self, props)\n}\n\nProxyWriter.prototype._stat = function () {\n  var self = this\n  var props = self.props\n  // stat the thing to see what the proxy should be.\n  var stat = props.follow ? 'stat' : 'lstat'\n\n  fs[stat](props.path, function (er, current) {\n    var type\n    if (er || !current) {\n      type = 'File'\n    } else {\n      type = getType(current)\n    }\n\n    props[type] = true\n    props.type = self.type = type\n\n    self._old = current\n    self._addProxy(Writer(props, current))\n  })\n}\n\nProxyWriter.prototype._addProxy = function (proxy) {\n  // console.error(\"~~ set proxy\", this.path)\n  var self = this\n  if (self._proxy) {\n    return self.error('proxy already set')\n  }\n\n  self._proxy = proxy\n  ;[\n    'ready',\n    'error',\n    'close',\n    'pipe',\n    'drain',\n    'warn'\n  ].forEach(function (ev) {\n    proxy.on(ev, self.emit.bind(self, ev))\n  })\n\n  self.emit('proxy', proxy)\n\n  var calls = self._buffer\n  calls.forEach(function (c) {\n    // console.error(\"~~ ~~ proxy buffered call\", c[0], c[1])\n    proxy[c[0]].apply(proxy, c[1])\n  })\n  self._buffer.length = 0\n  if (self._needsDrain) self.emit('drain')\n}\n\nProxyWriter.prototype.add = function (entry) {\n  // console.error(\"~~ proxy add\")\n  collect(entry)\n\n  if (!this._proxy) {\n    this._buffer.push(['add', [entry]])\n    this._needDrain = true\n    return false\n  }\n  return this._proxy.add(entry)\n}\n\nProxyWriter.prototype.write = function (c) {\n  // console.error('~~ proxy write')\n  if (!this._proxy) {\n    this._buffer.push(['write', [c]])\n    this._needDrain = true\n    return false\n  }\n  return this._proxy.write(c)\n}\n\nProxyWriter.prototype.end = function (c) {\n  // console.error('~~ proxy end')\n  if (!this._proxy) {\n    this._buffer.push(['end', [c]])\n    return false\n  }\n  return this._proxy.end(c)\n}\n"]}