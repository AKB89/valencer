{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["module.exports = Reader\n\nvar fs = require('graceful-fs')\nvar Stream = require('stream').Stream\nvar inherits = require('inherits')\nvar path = require('path')\nvar getType = require('./get-type.js')\nvar hardLinks = Reader.hardLinks = {}\nvar Abstract = require('./abstract.js')\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar LinkReader = require('./link-reader.js')\n\nfunction Reader (props, currentStat) {\n  var self = this\n  if (!(self instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === 'string') {\n    props = { path: props }\n  }\n\n  if (!props.path) {\n    self.error('Must provide a path', null, true)\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n  var type\n  var ClassType\n\n  if (props.type && typeof props.type === 'function') {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case 'Directory':\n      ClassType = require('./dir-reader.js')\n      break\n\n    case 'Link':\n    // XXX hard links are just files.\n    // However, it would be good to keep track of files' dev+inode\n    // and nlink values, and create a HardLinkReader that emits\n    // a linkpath value of the original copy, so that the tar\n    // writer can preserve them.\n    // ClassType = HardLinkReader\n    // break\n\n    case 'File':\n      ClassType = require('./file-reader.js')\n      break\n\n    case 'SymbolicLink':\n      ClassType = LinkReader\n      break\n\n    case 'Socket':\n      ClassType = require('./socket-reader.js')\n      break\n\n    case null:\n      ClassType = require('./proxy-reader.js')\n      break\n  }\n\n  if (!(self instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(self)\n\n  self.readable = true\n  self.writable = false\n\n  self.type = type\n  self.props = props\n  self.depth = props.depth = props.depth || 0\n  self.parent = props.parent || null\n  self.root = props.root || (props.parent && props.parent.root) || self\n\n  self._path = self.path = path.resolve(props.path)\n  if (process.platform === 'win32') {\n    self.path = self._path = self.path.replace(/\\?/g, '_')\n    if (self._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      self._swallowErrors = true\n      // if (self._path.indexOf(\" \") === -1) {\n      self._path = '\\\\\\\\?\\\\' + self.path.replace(/\\//g, '\\\\')\n    // }\n    }\n  }\n  self.basename = props.basename = path.basename(self.path)\n  self.dirname = props.dirname = path.dirname(self.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  self.size = props.size\n  self.filter = typeof props.filter === 'function' ? props.filter : null\n  if (props.sort === 'alpha') props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call self._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  self._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n    : a.toLowerCase() > b.toLowerCase() ? 1\n      : a.toLowerCase() < b.toLowerCase() ? -1\n        : a > b ? 1\n          : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var self = this\n  var props = self.props\n  var stat = props.follow ? 'stat' : 'lstat'\n  // console.error(\"Reader._stat\", self._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](self._path, statCb)\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", self._path, props_, props_.nlink)\n    if (er) return self.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== self.size && props.size !== self.size) {\n      return self.error('incorrect size')\n    }\n    self.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n\n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== 'Directory' && props.nlink && props.nlink > 1) {\n      var k = props.dev + ':' + props.ino\n      // console.error(\"Reader has nlink\", self._path, k)\n      if (hardLinks[k] === self._path || !hardLinks[k]) {\n        hardLinks[k] = self._path\n      } else {\n        // switch into hardlink mode.\n        type = self.type = self.props.type = 'Link'\n        self.Link = self.props.Link = true\n        self.linkpath = self.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", self._path, self.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        self._stat = self._read = LinkReader.prototype._read\n      }\n    }\n\n    if (self.type && self.type !== type) {\n      self.error('Unexpected type: ' + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (self.filter) {\n      var who = self._proxy || self\n      // special handling for ProxyReaders\n      if (!self.filter.call(who, who, props)) {\n        if (!self._disowned) {\n          self.abort()\n          self.emit('end')\n          self.emit('close')\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = ['_stat', 'stat', 'ready']\n    var e = 0\n    ;(function go () {\n      if (self._aborted) {\n        self.emit('end')\n        self.emit('close')\n        return\n      }\n\n      if (self._paused && self.type !== 'Directory') {\n        self.once('resume', go)\n        return\n      }\n\n      var ev = events[e++]\n      if (!ev) {\n        return self._read()\n      }\n      self.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest) {\n  var self = this\n  if (typeof dest.add === 'function') {\n    // piping to a multi-compatible, and we've got directory entries.\n    self.on('entry', function (entry) {\n      var ret = dest.add(entry)\n      if (ret === false) {\n        self.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit('pause', who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit('resume', who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error('Cannot read unknown type: ' + this.type)\n}\n"]}