{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["\"use strict\"\n\nvar debug = require('debug')('tar-pack')\nvar uidNumber = require('uid-number')\nvar rm = require('rimraf')\nvar tar = require('tar')\nvar once = require('once')\nvar fstream = require('fstream')\nvar packer = require('fstream-ignore')\n\nvar PassThrough = require('stream').PassThrough || require('readable-stream').PassThrough\nvar zlib = require('zlib')\nvar path = require('path')\n\nvar win32 = process.platform === 'win32'\nvar myUid = process.getuid && process.getuid()\nvar myGid = process.getgid && process.getgid()\n\nif (process.env.SUDO_UID && myUid === 0) {\n  if (!isNaN(process.env.SUDO_UID)) myUid = +process.env.SUDO_UID\n  if (!isNaN(process.env.SUDO_GID)) myGid = +process.env.SUDO_GID\n}\n\nexports.pack = pack\nexports.unpack = unpack\n\nfunction pack(folder, options) {\n  options = options || {}\n  if (typeof folder === 'string') {\n\n    var filter = options.filter || function (entry) { return true; }\n\n    folder = packer({\n      path: folder,\n      type: 'Directory',\n      isDirectory: true,\n      ignoreFiles: options.ignoreFiles || ['.gitignore'],\n      filter: function (entry) { // {path, basename, dirname, type} (type is \"Directory\" or \"File\")\n        var basename = entry.basename\n        // some files are *never* allowed under any circumstances\n        // these files should always be either temporary files or\n        // version control related files\n        if (basename === '.git' || basename === '.lock-wscript' || basename.match(/^\\.wafpickle-[0-9]+$/) ||\n            basename === 'CVS' || basename === '.svn' || basename === '.hg' || basename.match(/^\\..*\\.swp$/) ||\n            basename === '.DS_Store' ||  basename.match(/^\\._/)) {\n          return false\n        }\n        //custom excludes\n        return filter(entry)\n      }\n    })\n  }\n  // By default, npm includes some proprietary attributes in the\n  // package tarball.  This is sane, and allowed by the spec.\n  // However, npm *itself* excludes these from its own package,\n  // so that it can be more easily bootstrapped using old and\n  // non-compliant tar implementations.\n  var tarPack = tar.Pack({ noProprietary: options.noProprietary || false })\n  var gzip = zlib.Gzip()\n\n  folder\n    .on('error', function (er) {\n      if (er) debug('Error reading folder')\n      return gzip.emit('error', er)\n    })\n  tarPack\n    .on('error', function (er) {\n      if (er) debug('tar creation error')\n      gzip.emit('error', er)\n    })\n  return folder.pipe(tarPack).pipe(gzip)\n}\n\nfunction unpack(unpackTarget, options, cb) {\n  if (typeof options === 'function' && cb === undefined) cb = options, options = undefined\n\n  var tarball = new PassThrough()\n  if (typeof cb === 'function') {\n    cb = once(cb)\n    tarball.on('error', cb)\n    tarball.on('close', function () {\n      cb()\n    })\n  }\n\n  var parent = path.dirname(unpackTarget)\n  var base = path.basename(unpackTarget)\n\n  options = options || {}\n  var gid = options.gid || null\n  var uid = options.uid || null\n  var dMode = options.dmode || 0x0777 //npm.modes.exec\n  var fMode = options.fmode || 0x0666 //npm.modes.file\n  var defaultName = options.defaultName || (options.defaultName === false ? false : 'index.js')\n\n  // figure out who we're supposed to be, if we're not pretending\n  // to be a specific user.\n  if (options.unsafe && !win32) {\n    uid = myUid\n    gid = myGid\n  }\n\n  var pending = 2\n  uidNumber(uid, gid, function (er, uid, gid) {\n    if (er) {\n      tarball.emit('error', er)\n      return tarball.end()\n    }\n    if (0 === --pending) next()\n  })\n  rm(unpackTarget, function (er) {\n    if (er) {\n      tarball.emit('error', er)\n      return tarball.end()\n    }\n    if (0 === --pending) next()\n  })\n  function next() {\n    // gzip {tarball} --decompress --stdout \\\n    //   | tar -mvxpf - --strip-components=1 -C {unpackTarget}\n    gunzTarPerm(tarball, unpackTarget, dMode, fMode, uid, gid, defaultName)\n  }\n  return tarball\n}\n\n\nfunction gunzTarPerm(tarball, target, dMode, fMode, uid, gid, defaultName) {\n  debug('modes %j', [dMode.toString(8), fMode.toString(8)])\n\n  function fixEntry(entry) {\n    debug('fixEntry %j', entry.path)\n    // never create things that are user-unreadable,\n    // or dirs that are user-un-listable. Only leads to headaches.\n    var originalMode = entry.mode = entry.mode || entry.props.mode\n    entry.mode = entry.mode | (entry.type === 'Directory' ? dMode : fMode)\n    entry.props.mode = entry.mode\n    if (originalMode !== entry.mode) {\n      debug('modified mode %j', [entry.path, originalMode, entry.mode])\n    }\n\n    // if there's a specific owner uid/gid that we want, then set that\n    if (!win32 &&  typeof uid === 'number' && typeof gid === 'number') {\n      entry.props.uid = entry.uid = uid\n      entry.props.gid = entry.gid = gid\n    }\n  }\n\n  var extractOpts = { type: 'Directory', path: target, strip: 1 }\n\n  if (!win32 && typeof uid === 'number' && typeof gid === 'number') {\n    extractOpts.uid = uid\n    extractOpts.gid = gid\n  }\n\n  extractOpts.filter = function () {\n    // symbolic links are not allowed in packages.\n    if (this.type.match(/^.*Link$/)) {\n      debug('excluding symbolic link: ' + this.path.substr(target.length + 1) + ' -> ' + this.linkpath)\n      return false\n    }\n    return true\n  }\n\n\n  type(tarball, function (err, type) {\n    if (err) return tarball.emit('error', err)\n    var strm = tarball\n    if (type === 'gzip') {\n      strm = strm.pipe(zlib.Unzip())\n      strm.on('error', function (er) {\n          if (er) debug('unzip error')\n          tarball.emit('error', er)\n        })\n      type = 'tar'\n    }\n    if (type === 'tar') {\n      strm\n        .pipe(tar.Extract(extractOpts))\n        .on('entry', fixEntry)\n        .on('error', function (er) {\n          if (er) debug('untar error')\n          tarball.emit('error', er)\n        })\n        .on('close', function () {\n          tarball.emit('close')\n        })\n      return\n    }\n    if (type === 'naked-file' && defaultName) {\n      var jsOpts = { path: path.resolve(target, defaultName) }\n\n      if (!win32 && typeof uid === 'number' && typeof gid === 'number') {\n        jsOpts.uid = uid\n        jsOpts.gid = gid\n      }\n\n      strm\n        .pipe(fstream.Writer(jsOpts))\n        .on('error', function (er) {\n          if (er) debug('copy error')\n          tarball.emit('error', er)\n        })\n        .on('close', function () {\n          tarball.emit('close')\n        })\n      return\n    }\n\n    return cb(new Error('Unrecognised package type'));\n  })\n}\n\nfunction type(stream, callback) {\n  stream.on('error', handle)\n  stream.on('data', parse)\n  function handle(err) {\n    stream.removeListener('data', parse)\n    stream.removeListener('error', handle)\n  }\n  function parse(chunk) {\n    // detect what it is.\n    // Then, depending on that, we'll figure out whether it's\n    // a single-file module, gzipped tarball, or naked tarball.\n\n    // gzipped files all start with 1f8b08\n    if (chunk[0] === 0x1F && chunk[1] === 0x8B && chunk[2] === 0x08) {\n      callback(null, 'gzip')\n    } else if (chunk.toString().match(/^package\\/\\u0000/)) {\n      // note, this will only pick up on tarballs with a root directory called package\n      callback(null, 'tar')\n    } else {\n      callback(null, 'naked-file')\n    }\n\n    // now un-hook, and re-emit the chunk\n    stream.removeListener('data', parse)\n    stream.removeListener('error', handle)\n    stream.unshift(chunk)\n  }\n}\n"]}